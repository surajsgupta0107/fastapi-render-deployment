<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workout & Routine Manager</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Login Section -->
    <div id="login-section" class="max-w-md mx-auto my-8">
        <form id="login-form" class="space-y-2 bg-white p-6 rounded shadow">
            <input type="text" name="username" placeholder="Username" required class="border px-2 py-1 rounded w-full">
            <input type="password" name="password" placeholder="Password" required class="border px-2 py-1 rounded w-full">
            <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded w-full">Sign in</button>
        </form>
        <form id="register-form" class="space-y-2 bg-white p-6 rounded shadow" style="display:none;">
            <input type="text" name="username" placeholder="Username" required class="border px-2 py-1 rounded w-full">
            <input type="password" name="password" placeholder="Password" required class="border px-2 py-1 rounded w-full">
            <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded w-full">Sign up</button>
        </form>
        <div class="flex justify-between mt-2">
            <button id="show-register" class="text-blue-600 underline text-sm">Register</button>
            <button id="show-login" class="text-blue-600 underline text-sm" style="display:none;">Back to Login</button>
        </div>
        <div id="login-error" class="text-red-500 mt-2"></div>
        <div id="register-error" class="text-red-500 mt-2"></div>
    </div>

    <!-- Main App UI (hidden until login) -->
    <div id="app-section" style="display:none;">
        <div class="container mx-auto py-8">
            <div class="flex justify-end mb-4">
                <button id="logout-btn" class="bg-red-500 text-white px-4 py-2 rounded">Log Out</button>
            </div>
            <h1 class="text-3xl font-bold mb-6 text-center">Workout & Routine Manager</h1>
            <div class="flex flex-col md:flex-row gap-8">
                <!-- Workouts Section -->
                <div class="w-full md:w-1/2 bg-white rounded shadow p-6">
                    <h2 class="text-xl font-semibold mb-4">Workouts</h2>
                    <button id="load-workouts" class="bg-blue-500 text-white px-4 py-2 rounded mb-4">
                        Load Workouts
                    </button>
                    <div id="workouts-list" class="mb-4"></div>
                    <form id="create-workout-form" class="space-y-2">
                        <input type="text" name="name" placeholder="Workout Name" class="border px-2 py-1 rounded w-full" required>
                        <input type="text" name="description" placeholder="Description" class="border px-2 py-1 rounded w-full">
                        <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded">Add Workout</button>
                    </form>
                </div>
                <!-- Routines Section -->
                <div class="w-full md:w-1/2 bg-white rounded shadow p-6">
                    <h2 class="text-xl font-semibold mb-4">Routines</h2>
                    <button id="load-routines" class="bg-purple-500 text-white px-4 py-2 rounded mb-4">
                        Load Routines
                    </button>
                    <div id="routines-list" class="mb-4"></div>
                    <form id="create-routine-form" class="space-y-2">
                        <input type="text" name="name" placeholder="Routine Name" class="border px-2 py-1 rounded w-full" required>
                        <input type="text" name="description" placeholder="Description" class="border px-2 py-1 rounded w-full">
                        <select name="workouts" id="routine-workouts-select" class="border px-2 py-1 rounded w-full" multiple required>
                            <!-- Options will be loaded by JS -->
                        </select>
                        <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded">Add Routine</button>
                    </form>
                    <div id="routine-detail" class="mt-6"></div>
                </div>
            </div>
        </div>
    </div>
    <script>
        let accessToken = null;
        let routinesData = [];

        // Toggle between login and register forms
        document.getElementById('show-register').addEventListener('click', function() {
            document.getElementById('login-form').style.display = 'none';
            document.getElementById('register-form').style.display = '';
            document.getElementById('show-register').style.display = 'none';
            document.getElementById('show-login').style.display = '';
            document.getElementById('login-error').textContent = '';
        });
        document.getElementById('show-login').addEventListener('click', function() {
            document.getElementById('login-form').style.display = '';
            document.getElementById('register-form').style.display = 'none';
            document.getElementById('show-register').style.display = '';
            document.getElementById('show-login').style.display = 'none';
            document.getElementById('register-error').textContent = '';
        });

        // Register form handler
        document.getElementById('register-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const payload = Object.fromEntries(formData.entries());
            const res = await fetch('/auth/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (res.ok) {
                // Auto-fill login form and switch to login
                document.getElementById('login-form').username.value = payload.username;
                document.getElementById('login-form').password.value = payload.password;
                document.getElementById('show-login').click();
                document.getElementById('register-error').textContent = '';
                document.getElementById('login-error').textContent = 'Registration successful! Please log in.';
            } else {
                const data = await res.json().catch(() => ({}));
                document.getElementById('register-error').textContent = data.detail || 'Registration failed.';
            }
        });

        // Show/hide app UI based on authentication
        function showApp() {
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('app-section').style.display = '';
            populateRoutineWorkouts();
        }
        function showLogin() {
            document.getElementById('login-section').style.display = '';
            document.getElementById('app-section').style.display = 'none';
        }

        // Login form handler
        document.getElementById('login-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const payload = new URLSearchParams(formData);
            const res = await fetch('/auth/token', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: payload
            });
            if (res.ok) {
                const data = await res.json();
                accessToken = data.access_token;
                document.getElementById('login-error').textContent = '';
                showApp();
            } else {
                document.getElementById('login-error').textContent = 'Invalid credentials';
            }
        });

        // Fetch and render workouts
        document.getElementById('load-workouts').addEventListener('click', async function() {
            const res = await fetch('/workouts/workouts', {
                headers: { 'Authorization': 'Bearer ' + accessToken }
            });
            if (res.ok) {
                const data = await res.json();
                renderWorkouts(data);
                populateRoutineWorkouts(); // keep routine select up to date
            } else {
                if (res.status === 401) showLogin();
            }
        });

        function renderWorkouts(workouts) {
            const list = document.getElementById('workouts-list');
            if (!workouts.length) {
                list.innerHTML = '<p class="text-gray-500">No workouts found.</p>';
                return;
            }
            list.innerHTML = '<ul class="list-disc pl-5">' +
                workouts.map(w => `<li><span class="font-semibold">${w.name}</span> - ${w.description || ''}</li>`).join('') +
                '</ul>';
        }

        // Create workout
        document.getElementById('create-workout-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const payload = Object.fromEntries(formData.entries());
            const res = await fetch('/workouts/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + accessToken
                },
                body: JSON.stringify(payload)
            });
            if (res.ok) {
                form.reset();
                document.getElementById('load-workouts').click();
            } else {
                if (res.status === 401) showLogin();
            }
        });

        // Fetch and render routines
        document.getElementById('load-routines').addEventListener('click', async function() {
            const res = await fetch('/routines/', {
                headers: { 'Authorization': 'Bearer ' + accessToken }
            });
            if (res.ok) {
                const data = await res.json();
                routinesData = data;
                renderRoutines(data);
            } else {
                if (res.status === 401) showLogin();
            }
        });

        function renderRoutines(routines) {
            const list = document.getElementById('routines-list');
            if (!routines.length) {
                list.innerHTML = '<p class="text-gray-500">No routines found.</p>';
                document.getElementById('routine-detail').innerHTML = '';
                return;
            }
            list.innerHTML = '<ul class="list-disc pl-5">' +
                routines.map(r => `<li><button class="text-left w-full hover:bg-gray-100 px-2 py-1 rounded" onclick="showRoutineDetail(${r.id})"><span class=\"font-semibold\">${r.name}</span> - ${r.description || ''}</button></li>`).join('') +
                '</ul>';
            document.getElementById('routine-detail').innerHTML = '';
        }

        // Show routine detail
        window.showRoutineDetail = function(routineId) {
            const routine = routinesData.find(r => r.id === routineId);
            if (!routine) return;
            let html = `<div class="bg-gray-50 p-4 rounded shadow">
                <h3 class="text-lg font-bold mb-2">${routine.name}</h3>
                <p class="mb-2 text-gray-700">${routine.description || ''}</p>
                <h4 class="font-semibold mb-1">Workouts:</h4>
                <ul class="list-disc pl-5">`;
            if (routine.workouts && routine.workouts.length) {
                html += routine.workouts.map(w => `<li>${w.name} <span class="text-gray-500">${w.description || ''}</span></li>`).join('');
            } else {
                html += '<li class="text-gray-500">No workouts in this routine.</li>';
            }
            html += '</ul></div>';
            document.getElementById('routine-detail').innerHTML = html;
        }

        // Populate workouts in the routine creation form
        async function populateRoutineWorkouts() {
            const res = await fetch('/workouts/workouts', {
                headers: { 'Authorization': 'Bearer ' + accessToken }
            });
            if (res.ok) {
                const workouts = await res.json();
                const select = document.getElementById('routine-workouts-select');
                select.innerHTML = workouts.map(w => `<option value="${w.id}">${w.name}</option>`).join('');
            } else if (res.status === 401) {
                showLogin();
            }
        }

        // Create routine
        document.getElementById('create-routine-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const name = formData.get('name');
            const description = formData.get('description');
            const workouts = Array.from(formData.getAll('workouts')).map(Number);
            const payload = { name, description, workouts };
            const res = await fetch('/routines/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + accessToken
                },
                body: JSON.stringify(payload)
            });
            if (res.ok) {
                form.reset();
                document.getElementById('load-routines').click();
            } else if (res.status === 401) {
                showLogin();
            }
        });

        // Logout button handler
        document.getElementById('logout-btn').addEventListener('click', function() {
            accessToken = null;
            showLogin();
        });
    </script>
</body>
</html> 